# Z-Tab 需求约束

## 数据持久化约束

### IndexedDB 数据同步
- **强制要求**：每次更新应用状态数据时，必须同步更新 IndexedDB
- 数据更新包括但不限于：
  - 添加、删除、修改站点（sites）
  - 修改布局（layout）
  - 更新设置（settings）
  - 修改用户偏好（主题、图标风格等）
- **同步时机**：在状态更新后立即同步，不要延迟
- **错误处理**：所有 IndexedDB 操作必须包含错误处理（try-catch 或 .catch()）
- **示例模式**：
  ```typescript
  // ✅ 正确：先更新状态，再同步数据库
  setItems(newItems)
  db.settings.set(LAYOUT_STORAGE_KEY, globalLayout).catch((err) => {
    console.error('Failed to save layout:', err)
  })
  
  // ❌ 错误：只更新状态，不同步数据库
  setItems(newItems)
  ```

### 数据加载约束
- 应用启动时，优先从 IndexedDB 加载数据
- 如果 IndexedDB 中没有数据，再使用默认值
- 加载数据时应该显示加载状态，避免闪烁

## 功能约束

### 拖拽和点击
- Widget 必须支持整个区域拖拽，不仅仅是特定区域
- 点击功能必须正常工作，不能与拖拽冲突
- 使用 `useDragAndClick` hook 实现拖拽和点击检测

### 布局持久化
- 布局变化必须立即保存到 IndexedDB
- 拖拽停止时也要保存布局（作为兜底）
- 刷新页面后布局必须正确恢复
- 添加网站的入口（add-site 按钮）必须始终排在最后一个组件的后面，位置应该根据最后一个组件的实际位置动态计算，而不是使用固定的保存位置。当其他组件被拖拽移动时，add-site 按钮应该自动跟随到最后一个组件的位置。

### 分页布局约束
- **网格限制**：WidgetGrid 采用 8×4 分页布局，每页最多容纳 8列×4行的组件
- **自动分页**：添加组件时，如果会导致当前页面超出 4 行限制，必须自动将组件分到新页面
- **布局算法**：通过 `canFitInPage` 函数检测组件是否能放入当前页面，通过 `paginateItems` 函数进行分页处理
- **位置保持**：使用 `mergePageLayoutIntoGlobal` 函数确保添加/删除组件时保持现有布局的连续性

## 待扩展约束
- [ ] 性能约束
- [ ] 兼容性约束
- [ ] 安全约束
